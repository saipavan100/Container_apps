name: Build & Deploy to Azure

on:
  push:
    branches:
      - main
      - develop

env:
  ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
  BACKEND_IMAGE: backend
  FRONTEND_IMAGE: frontend

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      # ----------------------------
      # Checkout
      # ----------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------------
      # Setup Buildx (IMPORTANT)
      # ----------------------------
      - name: Set up Docker Buildx (container driver)
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      # ----------------------------
      # Login to Azure Container Registry
      # ----------------------------
      - name: Log in to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # ----------------------------
      # Build & Push Backend (with cache)
      # ----------------------------
      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ secrets.ACR_REGISTRY }}/backend:latest
            ${{ secrets.ACR_REGISTRY }}/backend:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.ACR_REGISTRY }}/backend:buildcache
          cache-to: type=registry,ref=${{ secrets.ACR_REGISTRY }}/backend:buildcache,mode=max

      # ----------------------------
      # Build & Push Frontend (with cache)
      # ----------------------------
      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ secrets.ACR_REGISTRY }}/frontend:latest
            ${{ secrets.ACR_REGISTRY }}/frontend:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.ACR_REGISTRY }}/frontend:buildcache
          cache-to: type=registry,ref=${{ secrets.ACR_REGISTRY }}/frontend:buildcache,mode=max

      # ----------------------------
      # Azure Login
      # ----------------------------
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # ----------------------------
      # Deploy Backend to Container Apps
      # ----------------------------
      - name: Deploy Backend to Container Apps
        run: |
          az containerapp update \
            --name ${{ secrets.BACKEND_CONTAINER_APP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --image ${{ secrets.ACR_REGISTRY }}/backend:${{ github.sha }} \
            --registry-login-server ${{ secrets.ACR_REGISTRY }} \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }}

      # ----------------------------
      # Deploy Frontend to Container Apps
      # ----------------------------
      - name: Deploy Frontend to Container Apps
        run: |
          az containerapp update \
            --name ${{ secrets.FRONTEND_CONTAINER_APP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --image ${{ secrets.ACR_REGISTRY }}/frontend:${{ github.sha }} \
            --registry-login-server ${{ secrets.ACR_REGISTRY }} \
            --registry-username ${{ secrets.ACR_USERNAME }} \
            --registry-password ${{ secrets.ACR_PASSWORD }}

      # ----------------------------
      # Success Message
      # ----------------------------
      - name: Deployment Success
        run: |
          echo "✅ Backend: ${{ secrets.ACR_REGISTRY }}/backend:${{ github.sha }}"
          echo "✅ Frontend: ${{ secrets.ACR_REGISTRY }}/frontend:${{ github.sha }}"
